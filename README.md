## Репозиторий с простецкой CI для GitLAB для деплоя ВМ в VMWare с сохранением состояния в GitLab, базовой настройкой и развертывания пустого кластера кубера с NFS хранилкой
## Перед началом
Предполагается, что на клонируемой ВМ уже установлены open-vm-tools, задан логин/пасс и установлен openssh-server

На машине с ранером должен быть настроен клиент Vault для получения секретов Terraform`ом
# Как работает
## Terraform

CI использует локальные провайдеры, нахождение которых указывается в CI и providers.tf

Пошаговая работа:
1. Terraform обращается к Vault ( ```secret.tf```, ```providers.tf``` ) и берет логин с паролем (API) для доступа к VSphere
2. Подключается с полученными кредами к VSphere
3. Далее по описанной в файлах variables.tf, terraform.tfvars, main.tf, output.tf инфраструктуре деплоит ВМ и отдает данные о них (IP&Mac)

### Как работать
- Изменяете variables.tf (vsphere_server)
- Изменяете secret.tf (vault kv storage)
- Изменяете providers.tf (ключи для логина и пароля из стораджа волта)
- Изменяете terraform.tfvars (ОЧЕНЬ ВАЖНО СОБЛЮДАТЬ НАЗВАНИЯ!!! Шаблон мастер-нод "any-name-master-{1,2,3,...}", шаблон воркеров "any-name-worker-{1,2,3,...}")
- Запускаете Pipeline (Или запускается по коммиту в любой ветке)
  - "Terraform init" запускается автоматически
  - Деплоете новые ВМ по кнопке "Apply"
  - Обязательно после запускайте "Refresh State". Это надо, чтобы вы получили IP тачек после деплоя (Не дожидается сразу, т.к. в ряде случаев выплевывает "Unexpected EOF")
    - Биндите адреса и маки на роутере
    - Запускаете задачу "Ansible -> Reboot" (В ней будет ошибка таймаута - это сделано специально)
    - Запускате задачу "Refresh State" через 1-2 минуты и только после этого запускаете таски по настройке о описи хостов
    - ******** Это делаете только в случае статики адресов, без нее пропустите эти подшаги

### Если вы удалили или изменили ВМ терраформом - ОБЯЗАТЕЛЬНО запустите таск Netbox->Delete и потом Netbox->Write/Update

## Ansible

### В каждой роли изменяйте Defaults!
### Ansible не размечает диски - это надо делать вручную!

Все секреты и важная информация (в т.ч. логин и пароль для подключения к VM) берется из Vault. В каждой роли в Defaults->Main указываете все необходимые переменные

Расчитан на несколько стейджей:
- Первичная конфигурация
  - Установка нужных пакетов
  - Изменение хостнейма
  - Настройка "zabbix-agent"
- Описание VM в Netbox
  - Измените cluster и site в tasks->main
- Настройка нового кластера или добавление новых нод
  - Сначала устанавливаются пакеты
  - Потом определяются и настраиваются (calico и т.д.) мастера (в имени должно быть <name>-master-{1-...})
  - Далее определяются и настраиваются воркеры


## CI
### Перед началом:
- Создайте токен доступа к проекту
- Создайте переменные:
  - TF_PASSWORD - сам токен
  - TF_USERNAME - имя токена

### Схема работы (от деплоя ВМ до запуска ролей Ansible)
- По коммиту или вручную стартует пайплайн
- Инициализируется Terraform
- Вручную запускаются таски деплоя и обновления в стейдже "Terraform"
- Вручную запускаются таски "Ansible"
  - Питоновский скрипт "parcer.py" скачивает файл состояния и на его основе из шаблона создает inventory
  - Запускается роль Ansible

# АХТУНГ
- НЕ УДАЛЯЙТЕ ВЕТКИ В РЕПОЗИТОРИИ, ЕСЛИ ИЗ НЕЕ БЫЛИ СОЗДАНЫ ВМ, ПОКА НЕ ОЧИСТИТЕ ИНФРАСТРУКТУРУ
- НЕ УДАЛЯЙТЕ ФАЙЛ СОСТОЯНИЯ TERRAFORM С ИМЕНЕМ РАБОЧЕЙ ВЕТКИ
- НЕ ЗАБЫВАЙТЕ УДАЛЯТЬ АРТЕФАКТ ВЕТКИ ПОСЛЕ УДАЛЕНИЯ САМОЙ ВЕТКИ, ЕСЛИ ОНО БОЛЬШЕ НЕ НУЖНО

